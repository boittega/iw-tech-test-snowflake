{
"AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Create Snowflake Bucket, Role and Policy",
    "Metadata": {},
    "Parameters": {},
    "Mappings": {},
    "Conditions": {},
    "Resources": {
        
        "snowflakeS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "Private",
                "BucketName": "bottega-snowflake",
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration" : {
                    "BlockPublicAcls" : true,
                    "BlockPublicPolicy" : true,
                    "IgnorePublicAcls" : true,
                    "RestrictPublicBuckets" : true
                }
            }
        },

        "snowflakeRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "snowflake_access_role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                        "Effect": "Allow",
                        "Principal": {
                            "AWS": "arn:aws:iam::270302263326:user/12hj-s-iest2662"
                        },
                        "Action": "sts:AssumeRole",
                        "Condition": {
                            "StringEquals": {
                            "sts:ExternalId": "MD66426_SFCRole=2_93iLAGr6Mb3Fj26f9B2U/TCzmHI="
                            }
                        }
                        }
                    ]
                },
                "Path": "/"
            }
        },

        "snowflakeIamPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName" : "snowflake_access",
                "PolicyDocument" : {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:GetObjectVersion"
                            ],
                            "Resource": "arn:aws:s3:::bottega-snowflake/*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": "s3:ListBucket",
                            "Resource": "arn:aws:s3:::bottega-snowflake",
                            "Condition": {
                                "StringLike": {
                                    "s3:prefix": [
                                        "*"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "Roles": [ {
                   "Ref": "snowflakeRole"
                } ]
            }
        }
        
    },
    "Outputs": {}
}